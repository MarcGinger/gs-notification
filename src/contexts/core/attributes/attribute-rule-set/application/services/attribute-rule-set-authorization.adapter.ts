// @generated by gen v1.0.0 hash:regen
// REMOVE THIS COMMENT TO STOP AUTOMATIC UPDATES TO THIS BLOCK

import { Injectable } from '@nestjs/common';
import { AttributeRuleSetAuthorizationService } from './attribute-rule-set-authorization.service';
import { AuthorizationService } from 'src/shared/application/utils/use-case.runner';
import { Result, DomainError, err } from 'src/shared/errors';
import {
  AttributeRuleSetAuthContext,
  CrudOperation,
  BatchOperation,
} from '../types/attribute-rule-set-auth-context';
import { AttributeRuleSetErrors } from '../../domain/errors/attribute-rule-set.errors';

/**
 * Adapter that makes AttributeRuleSetAuthorizationService compatible with the generic AuthorizationService interface.
 * This allows attributeRuleSet use-cases to work with the runUseCaseWithSecurity function.
 *
 * Improvements:
 * - Type-safe operations with proper validation
 * - Structured AttributeRuleSetAuthContext instead of Record<string, any>
 * - Clear error handling for invalid operations
 */
@Injectable()
export class AttributeRuleSetAuthorizationAdapter
  implements AuthorizationService<AttributeRuleSetAuthContext>
{
  constructor(
    private readonly attributeRuleSetAuthorizationService: AttributeRuleSetAuthorizationService,
  ) {}

  async canCreateResource(
    userId: string,
    correlationId: string,
    context: AttributeRuleSetAuthContext,
  ): Promise<Result<boolean, DomainError>> {
    return this.attributeRuleSetAuthorizationService.canCreateAttributeRuleSet(
      userId,
      correlationId,
      context,
    );
  }

  async canReadResource(
    userId: string,
    resourceId: string,
    correlationId: string,
    context: AttributeRuleSetAuthContext,
  ): Promise<Result<boolean, DomainError>> {
    return this.attributeRuleSetAuthorizationService.canReadAttributeRuleSet(
      userId,
      resourceId,
      correlationId,
      context,
    );
  }

  async authorizeResourceOperation(
    userId: string,
    operation: string,
    correlationId: string,
    resourceId: string,
    fields?: string[],
    context?: AttributeRuleSetAuthContext,
  ): Promise<
    Result<
      {
        authorized: boolean;
        allowedFields?: string[];
        deniedFields?: string[];
      },
      DomainError
    >
  > {
    // Type-safe operation validation
    const allowedOperations = new Set<string>([
      'read',
      'create',
      'update',
      'delete',
    ]);
    if (!allowedOperations.has(operation)) {
      return err({
        ...AttributeRuleSetErrors.NOT_IMPLEMENTED,
        context: {
          codes: resourceId,
          userId,
          correlationId,
          operation,
          ...context,
        },
      });
    }

    const validOperation = operation as CrudOperation;
    return this.attributeRuleSetAuthorizationService.authorizeAttributeRuleSetOperation(
      userId,
      validOperation,
      correlationId,
      resourceId,
      fields,
      context,
    );
  }

  /**
   * Batch authorization check for multiple attributeRuleSets.
   * Useful for list operations where you need to filter results.
   *
   * @param userId - User identifier
   * @param codes - Array of attributeRuleSet codes to authorize
   * @param correlationId - Request correlation ID
   * @param operation - Operation type (read, update, delete)
   * @param context - AttributeRuleSet authorization context
   * @returns Result containing authorized and denied attributeRuleSet codes
   */
  async authorizeAttributeRuleSetList(
    userId: string,
    codes: string[],
    correlationId: string,
    operation: BatchOperation = 'read',
    context?: AttributeRuleSetAuthContext,
  ): Promise<Result<{ authorized: string[]; denied: string[] }, DomainError>> {
    return this.attributeRuleSetAuthorizationService.authorizeAttributeRuleSetList(
      userId,
      codes,
      correlationId,
      operation,
      context,
    );
  }
}
