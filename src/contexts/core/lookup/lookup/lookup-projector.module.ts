// @generated by gen v1.0.0 hash:regen
// REMOVE THIS COMMENT TO STOP AUTOMATIC UPDATES TO THIS BLOCK

// Lookup Projector Module
// Configures Lookup Projector with shared projection infrastructure

import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { InfrastructureModule } from 'src/shared/infrastructure/infrastructure.module';
import { LoggingModule } from 'src/shared/logging';
import { TimeModule } from 'src/shared/infrastructure/time';
import {
  IO_REDIS,
  CACHE_SERVICE,
  DATA_SOURCE,
} from 'src/shared/constants/injection-tokens';
import { EventStoreService } from 'src/shared/infrastructure/eventstore/eventstore.service';
import { LOOKUP_DI_TOKENS } from '../lookup.constants';
import { CoreProjectorConfig } from '../projector.config';
import { AppConfigUtil } from 'src/shared/config';
import { APP_LOGGER, type Logger } from 'src/shared/logging';
import { CatchUpRunner } from 'src/shared/infrastructure/projections/catchup.runner';
import type { Redis } from 'ioredis';
import type { CheckpointStore } from 'src/shared/infrastructure/projections/checkpoint.store';
import { LookupProjector } from './infrastructure/projectors';
import { LookupProjectorHealthController } from './interface/http/controllers';

@Module({
  imports: [
    // Shared projection infrastructure (includes EventStore, Redis, CatchUpRunner, etc.)
    InfrastructureModule,

    // Time infrastructure (provides CLOCK token)
    TimeModule,

    // Logging infrastructure
    LoggingModule,

    // Database access for raw SQL operations
    TypeOrmModule.forFeature([]),
  ],
  providers: [
    // Map lookup domain tokens to infrastructure tokens
    {
      provide: LOOKUP_DI_TOKENS.IO_REDIS, // 'LookupRedisClient'
      useExisting: IO_REDIS, // 'IORedis'
    },
    {
      provide: LOOKUP_DI_TOKENS.DATA_SOURCE, // 'LookupDataSource'
      useExisting: DATA_SOURCE, // 'DATA_SOURCE'
    },
    {
      provide: LOOKUP_DI_TOKENS.CHECKPOINT_STORE, // 'LookupCheckpointStore'
      inject: [IO_REDIS, APP_LOGGER],
      useFactory: (redis: Redis, logger: Logger) => {
        const envPrefix = `${AppConfigUtil.getEnvironment()}:`;
        const factory = CoreProjectorConfig.createCheckpointStoreFactory();
        return factory(redis, logger, envPrefix);
      },
    },
    {
      provide: LOOKUP_DI_TOKENS.CACHE_SERVICE, // 'LookupCacheService'
      useExisting: CACHE_SERVICE, // 'CACHE_SERVICE'
    },
    {
      provide: LOOKUP_DI_TOKENS.CATCHUP_RUNNER, // 'LookupCatchupRunner'
      inject: [
        EventStoreService,
        LOOKUP_DI_TOKENS.CHECKPOINT_STORE,
        APP_LOGGER,
      ],
      useFactory: (
        eventStoreService: EventStoreService,
        checkpointStore: CheckpointStore,
        logger: Logger,
      ) => {
        return new CatchUpRunner(eventStoreService, checkpointStore, logger);
      },
    },
    LookupProjector,
  ],
  controllers: [LookupProjectorHealthController],
  exports: [LookupProjector],
})
export class LookupProjectorModule {}
