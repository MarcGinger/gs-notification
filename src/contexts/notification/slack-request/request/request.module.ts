// @generated by gen v1.0.0 hash:regen
// REMOVE THIS COMMENT TO STOP AUTOMATIC UPDATES TO THIS BLOCK

import { Module } from '@nestjs/common';
import { BullMQModule } from 'src/shared/infrastructure/queue/bullmq.module';
import { AppConfigUtil } from 'src/shared/config/app-config.util';

// Import slack-config modules for query interfaces
import { WorkspaceModule } from 'src/contexts/notification/slack-config/workspace/workspace.module';
import { TemplateModule } from 'src/contexts/notification/slack-config/template/template.module';
import { ChannelModule } from 'src/contexts/notification/slack-config/channel/channel.module';
import { AppConfigModule } from 'src/contexts/notification/slack-config/app-config/app-config.module';
import {
  RedisIdempotencyService,
  IdempotencyConfig,
} from 'src/shared/infrastructure';

import { SLACK_REQUEST_DI_TOKENS } from '../slack-request.constants';
import { REQUEST_APP_PORT } from './application/ports/request-app.port';
import { SlackRequestSharedModule } from '../slack-request-shared.module';
import { RequestController } from './interface/http/controllers';
import {
  RequestApplicationService,
  RequestAuthorizationService,
  RequestAuthorizationAdapter,
  RequestForeignKeyValidatorService,
} from './application/services';
import {
  ICreateRequestUseCase,
  CreateRequestUseCase,
  IGetRequestUseCase,
  GetRequestUseCase,
  IListRequestUseCase,
  ListRequestUseCase,
  ISentRequestUseCase,
  SentRequestUseCase,
  IFailedRequestUseCase,
  FailedRequestUseCase,
} from './application/use-cases';

// import { IRequestRepository } from './application/ports';
import {
  RequestQueryRepository,
  RequestReaderRepository,
  RequestWriterRepository,
  WorkspaceReaderRepository,
  TemplateReaderRepository,
  ChannelReaderRepository,
} from './infrastructure/repositories';

import {
  RequestQueueService,
  SendRequestWorkerService,
} from './infrastructure/services';
import { RequestProcessor } from './infrastructure/processors';
import { RequestTemplateAdapter } from './infrastructure/services/request-template.adapter';
import { TemplateRendererService } from 'src/shared/infrastructure';
// Tokens for injection - imported directly from port files
import {
  REQUEST_READER_TOKEN,
  REQUEST_WRITER_TOKEN,
  WORKSPACE_REFERENCE_READER_TOKEN,
  TEMPLATE_REFERENCE_READER_TOKEN,
  CHANNEL_REFERENCE_READER_TOKEN,
  REQUEST_QUERY_TOKEN,
} from './application/ports';
@Module({
  imports: [
    SlackRequestSharedModule, // Provides all common infrastructure and services
    // Import slack-config modules for query interfaces
    WorkspaceModule,
    TemplateModule,
    ChannelModule,
    AppConfigModule,
    // Domain-specific BullMQ queue registration
    BullMQModule.register({
      redisUrl: AppConfigUtil.getRedisConfig().url,
      keyPrefix: `${AppConfigUtil.getEnvironment()}:request:`,
      enableMetrics: true,
      queues: [
        {
          name: 'RequestQueue',
          defaultJobOptions: {
            removeOnComplete: 100,
            removeOnFail: 50,
            attempts: 3,
            backoff: {
              type: 'exponential',
              delay: 2000,
            },
            delay: 0, // Process immediately by default
          },
        },
      ],
    }),
  ],
  controllers: [RequestController],
  providers: [
    // Repository implementations with tokens (before services that depend on them)
    {
      provide: REQUEST_READER_TOKEN,
      useClass: RequestReaderRepository,
    },
    {
      provide: REQUEST_WRITER_TOKEN,
      useClass: RequestWriterRepository,
    },
    {
      provide: REQUEST_QUERY_TOKEN,
      useClass: RequestQueryRepository,
    },

    // Bounded Context Reader Repositories
    {
      provide: WORKSPACE_REFERENCE_READER_TOKEN,
      useClass: WorkspaceReaderRepository,
    },
    {
      provide: TEMPLATE_REFERENCE_READER_TOKEN,
      useClass: TemplateReaderRepository,
    },
    {
      provide: CHANNEL_REFERENCE_READER_TOKEN,
      useClass: ChannelReaderRepository,
    },

    // Services that depend on repositories
    RequestApplicationService,
    RequestAuthorizationService,
    RequestAuthorizationAdapter,
    RequestForeignKeyValidatorService,

    // Application Port (Service implements interface directly)
    {
      provide: REQUEST_APP_PORT,
      useExisting: RequestApplicationService,
    },

    // Queue and processing services
    RequestQueueService,
    RequestProcessor,
    TemplateRendererService, // Shared template rendering service
    RequestTemplateAdapter, // Context-specific adapter
    SendRequestWorkerService,

    // Idempotency service configuration
    {
      provide: 'IDEMPOTENCY_CONFIG',
      useValue: {
        namespace: 'notification.slack',
        version: 'v1',
        entityType: 'message-request',
        executionTtl: 900, // 15 minutes
      } as IdempotencyConfig,
    },
    {
      provide: 'REDIS',
      useExisting: SLACK_REQUEST_DI_TOKENS.IO_REDIS,
    },
    {
      provide: 'RequestIdempotencyService',
      useClass: RedisIdempotencyService,
    },

    // Use case implementations
    {
      provide: ICreateRequestUseCase,
      useClass: CreateRequestUseCase,
    },
    {
      provide: IGetRequestUseCase,
      useClass: GetRequestUseCase,
    },
    {
      provide: IListRequestUseCase,
      useClass: ListRequestUseCase,
    },
    {
      provide: ISentRequestUseCase,
      useClass: SentRequestUseCase,
    },
    {
      provide: IFailedRequestUseCase,
      useClass: FailedRequestUseCase,
    },
  ],
  exports: [
    // Repository tokens for external module consumption
    REQUEST_READER_TOKEN,
    REQUEST_WRITER_TOKEN,
    REQUEST_QUERY_TOKEN,
    // Bounded Context Reader tokens
    WORKSPACE_REFERENCE_READER_TOKEN,
    TEMPLATE_REFERENCE_READER_TOKEN,
    CHANNEL_REFERENCE_READER_TOKEN,
    // Queue service for external access
    RequestQueueService,
    // Idempotency service for projector access
    'RequestIdempotencyService',
  ],
})
export class RequestModule {}
