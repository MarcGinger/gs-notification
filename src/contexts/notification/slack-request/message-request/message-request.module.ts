// @generated by gen v1.0.0 hash:regen
// REMOVE THIS COMMENT TO STOP AUTOMATIC UPDATES TO THIS BLOCK

import { Module } from '@nestjs/common';
import { BullMQModule } from 'src/shared/infrastructure/queue/bullmq.module';
import { AppConfigUtil } from 'src/shared/config/app-config.util';
import { SlackRequestSharedModule } from '../slack-request-shared.module';

// Import slack-config modules for query interfaces
import { WorkspaceModule } from 'src/contexts/notification/slack-config/workspace/workspace.module';
import { TemplateModule } from 'src/contexts/notification/slack-config/template/template.module';
import { ChannelModule } from 'src/contexts/notification/slack-config/channel/channel.module';
import { AppConfigModule } from 'src/contexts/notification/slack-config/app-config/app-config.module';
import { MessageRequestController } from './interface/http/controllers';
import {
  MessageRequestApplicationService,
  MessageRequestAuthorizationService,
  MessageRequestAuthorizationAdapter,
  MessageRequestForeignKeyValidatorService,
} from './application/services';

import { MESSAGE_REQUEST_APP_PORT } from './application/ports/message-request-app.port';
import {
  ICreateMessageRequestUseCase,
  CreateMessageRequestUseCase,
  IGetMessageRequestUseCase,
  GetMessageRequestUseCase,
  IListMessageRequestUseCase,
  ListMessageRequestUseCase,
  IRecordMessageSentUseCase,
  RecordMessageSentUseCase,
  IRecordMessageFailedUseCase,
  RecordMessageFailedUseCase,
} from './application/use-cases';

// import { IMessageRequestRepository } from './application/ports';
import {
  MessageRequestQueryRepository,
  MessageRequestReaderRepository,
  MessageRequestWriterRepository,
  WorkspaceReaderRepository,
  TemplateReaderRepository,
  ChannelReaderRepository,
} from './infrastructure/repositories';
import {
  MessageRequestQueueService,
  MessageRequestIdempotencyService,
  SendMessageWorkerService,
} from './infrastructure/services';
import { MessageRequestProcessor } from './infrastructure/processors';
import { TemplateRendererService } from './infrastructure/services/template-renderer.service';

// Tokens for injection - imported directly from port files
import {
  MESSAGE_REQUEST_READER_TOKEN,
  MESSAGE_REQUEST_WRITER_TOKEN,
  WORKSPACE_REFERENCE_READER_TOKEN,
  TEMPLATE_REFERENCE_READER_TOKEN,
  CHANNEL_REFERENCE_READER_TOKEN,
  MESSAGE_REQUEST_QUERY_TOKEN,
} from './application/ports';
@Module({
  imports: [
    SlackRequestSharedModule, // Provides all common infrastructure and services
    // Import slack-config modules for query interfaces
    WorkspaceModule,
    TemplateModule,
    ChannelModule,
    AppConfigModule,
    // Domain-specific BullMQ queue registration
    BullMQModule.register({
      redisUrl: AppConfigUtil.getRedisConfig().url,
      keyPrefix: `${AppConfigUtil.getEnvironment()}:message-request:`,
      enableMetrics: true,
      queues: [
        {
          name: 'MessageRequestQueue',
          defaultJobOptions: {
            removeOnComplete: 100,
            removeOnFail: 50,
            attempts: 3,
            backoff: {
              type: 'exponential',
              delay: 2000,
            },
            delay: 0, // Process immediately by default
          },
        },
      ],
    }),
  ],
  controllers: [MessageRequestController],
  providers: [
    // Repository implementations with tokens (before services that depend on them)
    {
      provide: MESSAGE_REQUEST_READER_TOKEN,
      useClass: MessageRequestReaderRepository,
    },
    {
      provide: MESSAGE_REQUEST_WRITER_TOKEN,
      useClass: MessageRequestWriterRepository,
    },
    {
      provide: MESSAGE_REQUEST_QUERY_TOKEN,
      useClass: MessageRequestQueryRepository,
    },

    // Bounded Context Reader Repositories
    {
      provide: WORKSPACE_REFERENCE_READER_TOKEN,
      useClass: WorkspaceReaderRepository,
    },
    {
      provide: TEMPLATE_REFERENCE_READER_TOKEN,
      useClass: TemplateReaderRepository,
    },
    {
      provide: CHANNEL_REFERENCE_READER_TOKEN,
      useClass: ChannelReaderRepository,
    },

    // Services that depend on repositories
    MessageRequestApplicationService,
    MessageRequestAuthorizationService,
    MessageRequestAuthorizationAdapter,
    MessageRequestForeignKeyValidatorService,

    // Application Port (Service implements interface directly)
    {
      provide: MESSAGE_REQUEST_APP_PORT,
      useExisting: MessageRequestApplicationService,
    },

    // Queue and processing services
    MessageRequestQueueService,
    MessageRequestProcessor,
    TemplateRendererService,
    MessageRequestIdempotencyService,
    SendMessageWorkerService,

    // Use case implementations
    {
      provide: ICreateMessageRequestUseCase,
      useClass: CreateMessageRequestUseCase,
    },
    {
      provide: IGetMessageRequestUseCase,
      useClass: GetMessageRequestUseCase,
    },
    {
      provide: IListMessageRequestUseCase,
      useClass: ListMessageRequestUseCase,
    },
    {
      provide: IRecordMessageSentUseCase,
      useClass: RecordMessageSentUseCase,
    },
    {
      provide: IRecordMessageFailedUseCase,
      useClass: RecordMessageFailedUseCase,
    },
  ],
  exports: [
    // Repository tokens for external module consumption
    MESSAGE_REQUEST_READER_TOKEN,
    MESSAGE_REQUEST_WRITER_TOKEN,
    MESSAGE_REQUEST_QUERY_TOKEN,
    // Bounded Context Reader tokens
    WORKSPACE_REFERENCE_READER_TOKEN,
    TEMPLATE_REFERENCE_READER_TOKEN,
    CHANNEL_REFERENCE_READER_TOKEN,
    // Queue service for external access
    MessageRequestQueueService,
    // Idempotency service for projector access
    MessageRequestIdempotencyService,
  ],
})
export class MessageRequestModule {}
