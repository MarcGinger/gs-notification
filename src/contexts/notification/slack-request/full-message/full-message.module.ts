// @generated by gen v1.0.0 hash:regen
// REMOVE THIS COMMENT TO STOP AUTOMATIC UPDATES TO THIS BLOCK

import { Module } from '@nestjs/common';
import { BullMQModule } from 'src/shared/infrastructure/queue/bullmq.module';
import { AppConfigUtil } from 'src/shared/config/app-config.util';

// Import slack-config modules for query interfaces
import { WorkspaceModule } from 'src/contexts/notification/slack-config/workspace/workspace.module';
import { TemplateModule } from 'src/contexts/notification/slack-config/template/template.module';
import { ChannelModule } from 'src/contexts/notification/slack-config/channel/channel.module';
import { AppConfigModule } from 'src/contexts/notification/slack-config/app-config/app-config.module';
import {
  RedisIdempotencyService,
  IdempotencyConfig,
} from 'src/shared/infrastructure';

import { SLACK_REQUEST_DI_TOKENS } from '../slack-request.constants';
import { FULL_MESSAGE_APP_PORT } from './application/ports/full-message-app.port';
import { SlackRequestSharedModule } from '../slack-request-shared.module';
import { FullMessageController } from './interface/http/controllers';
import {
  FullMessageApplicationService,
  FullMessageAuthorizationService,
  FullMessageAuthorizationAdapter,
  FullMessageForeignKeyValidatorService,
} from './application/services';
import {
  ICreateFullMessageUseCase,
  CreateFullMessageUseCase,
  IGetFullMessageUseCase,
  GetFullMessageUseCase,
  IListFullMessageUseCase,
  ListFullMessageUseCase,
  ISentFullMessageUseCase,
  SentFullMessageUseCase,
  IFailedFullMessageUseCase,
  FailedFullMessageUseCase,
} from './application/use-cases';

// import { IFullMessageRepository } from './application/ports';
import {
  FullMessageQueryRepository,
  FullMessageReaderRepository,
  FullMessageWriterRepository,
  WorkspaceReaderRepository,
  TemplateReaderRepository,
  ChannelReaderRepository,
} from './infrastructure/repositories';

import {
  FullMessageQueueService,
  SendFullMessageWorkerService,
} from './infrastructure/services';
import { FullMessageProcessor } from './infrastructure/processors';
import { FullMessageTemplateAdapter } from './infrastructure/services/full-message-template.adapter';
import { TemplateRendererService } from 'src/shared/infrastructure';
// Tokens for injection - imported directly from port files
import {
  FULL_MESSAGE_READER_TOKEN,
  FULL_MESSAGE_WRITER_TOKEN,
  WORKSPACE_REFERENCE_READER_TOKEN,
  TEMPLATE_REFERENCE_READER_TOKEN,
  CHANNEL_REFERENCE_READER_TOKEN,
  FULL_MESSAGE_QUERY_TOKEN,
} from './application/ports';
@Module({
  imports: [
    SlackRequestSharedModule, // Provides all common infrastructure and services
    // Import slack-config modules for query interfaces
    WorkspaceModule,
    TemplateModule,
    ChannelModule,
    AppConfigModule,
    // Domain-specific BullMQ queue registration
    BullMQModule.register({
      redisUrl: AppConfigUtil.getRedisConfig().url,
      keyPrefix: `${AppConfigUtil.getEnvironment()}:full-message:`,
      enableMetrics: true,
      queues: [
        {
          name: 'FullMessageQueue',
          defaultJobOptions: {
            removeOnComplete: 100,
            removeOnFail: 50,
            attempts: 3,
            backoff: {
              type: 'exponential',
              delay: 2000,
            },
            delay: 0, // Process immediately by default
          },
        },
      ],
    }),
  ],
  controllers: [FullMessageController],
  providers: [
    // Repository implementations with tokens (before services that depend on them)
    {
      provide: FULL_MESSAGE_READER_TOKEN,
      useClass: FullMessageReaderRepository,
    },
    {
      provide: FULL_MESSAGE_WRITER_TOKEN,
      useClass: FullMessageWriterRepository,
    },
    {
      provide: FULL_MESSAGE_QUERY_TOKEN,
      useClass: FullMessageQueryRepository,
    },

    // Bounded Context Reader Repositories
    {
      provide: WORKSPACE_REFERENCE_READER_TOKEN,
      useClass: WorkspaceReaderRepository,
    },
    {
      provide: TEMPLATE_REFERENCE_READER_TOKEN,
      useClass: TemplateReaderRepository,
    },
    {
      provide: CHANNEL_REFERENCE_READER_TOKEN,
      useClass: ChannelReaderRepository,
    },

    // Services that depend on repositories
    FullMessageApplicationService,
    FullMessageAuthorizationService,
    FullMessageAuthorizationAdapter,
    FullMessageForeignKeyValidatorService,

    // Application Port (Service implements interface directly)
    {
      provide: FULL_MESSAGE_APP_PORT,
      useExisting: FullMessageApplicationService,
    },

    // Queue and processing services
    FullMessageQueueService,
    FullMessageProcessor,
    TemplateRendererService, // Shared template rendering service
    FullMessageTemplateAdapter, // Context-specific adapter
    SendFullMessageWorkerService,

    // Idempotency service configuration
    {
      provide: 'IDEMPOTENCY_CONFIG',
      useValue: {
        namespace: 'notification.slack',
        version: 'v1',
        entityType: 'message-request',
        executionTtl: 900, // 15 minutes
      } as IdempotencyConfig,
    },
    {
      provide: 'REDIS',
      useExisting: SLACK_REQUEST_DI_TOKENS.IO_REDIS,
    },
    {
      provide: 'FullMessageIdempotencyService',
      useClass: RedisIdempotencyService,
    },

    // Use case implementations
    {
      provide: ICreateFullMessageUseCase,
      useClass: CreateFullMessageUseCase,
    },
    {
      provide: IGetFullMessageUseCase,
      useClass: GetFullMessageUseCase,
    },
    {
      provide: IListFullMessageUseCase,
      useClass: ListFullMessageUseCase,
    },
    {
      provide: ISentFullMessageUseCase,
      useClass: SentFullMessageUseCase,
    },
    {
      provide: IFailedFullMessageUseCase,
      useClass: FailedFullMessageUseCase,
    },
  ],
  exports: [
    // Repository tokens for external module consumption
    FULL_MESSAGE_READER_TOKEN,
    FULL_MESSAGE_WRITER_TOKEN,
    FULL_MESSAGE_QUERY_TOKEN,
    // Bounded Context Reader tokens
    WORKSPACE_REFERENCE_READER_TOKEN,
    TEMPLATE_REFERENCE_READER_TOKEN,
    CHANNEL_REFERENCE_READER_TOKEN,
    // Queue service for external access
    FullMessageQueueService,
    // Idempotency service for projector access
    'FullMessageIdempotencyService',
  ],
})
export class FullMessageModule {}
