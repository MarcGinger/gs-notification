// @generated by gen v1.0.0 hash:regen
// REMOVE THIS COMMENT TO STOP AUTOMATIC UPDATES TO THIS BLOCK

// Template Projector Module
// Configures Template Projector with shared projection infrastructure

import { Module } from '@nestjs/common';
import { TypeOrmModule } from '@nestjs/typeorm';
import { InfrastructureModule } from 'src/shared/infrastructure/infrastructure.module';
import { LoggingModule } from 'src/shared/logging';
import { TimeModule } from 'src/shared/infrastructure/time';
import {
  IO_REDIS,
  CACHE_SERVICE,
  DATA_SOURCE,
} from 'src/shared/constants/injection-tokens';
import { EventStoreService } from 'src/shared/infrastructure/eventstore/eventstore.service';
import { SLACK_CONFIG_DI_TOKENS } from '../slack-config.constants';
import { NotificationSlackProjectorConfig } from '../projector.config';
import { AppConfigUtil } from 'src/shared/config';
import { APP_LOGGER, type Logger } from 'src/shared/logging';
import { CatchUpRunner } from 'src/shared/infrastructure/projections/catchup.runner';
import type { Redis } from 'ioredis';
import type { CheckpointStore } from 'src/shared/infrastructure/projections/checkpoint.store';

import { TemplateProjector } from './infrastructure/projectors';
import { TemplateProjectorHealthController } from './interface/http/controllers';

@Module({
  imports: [
    // Shared projection infrastructure (includes EventStore, Redis, CatchUpRunner, etc.)
    InfrastructureModule,

    // Time infrastructure (provides CLOCK token)
    TimeModule,

    // Logging infrastructure
    LoggingModule,

    // Database access for raw SQL operations
    TypeOrmModule.forFeature([]),
  ],
  providers: [
    // Map slack-config domain tokens to infrastructure tokens
    {
      provide: SLACK_CONFIG_DI_TOKENS.IO_REDIS, // 'SlackConfigRedisClient'
      useExisting: IO_REDIS, // 'IORedis'
    },
    {
      provide: SLACK_CONFIG_DI_TOKENS.DATA_SOURCE, // 'SlackConfigDataSource'
      useExisting: DATA_SOURCE, // 'DATA_SOURCE'
    },
    {
      provide: SLACK_CONFIG_DI_TOKENS.CHECKPOINT_STORE, // 'SlackConfigCheckpointStore'
      inject: [IO_REDIS, APP_LOGGER],
      useFactory: (redis: Redis, logger: Logger) => {
        const envPrefix = `${AppConfigUtil.getEnvironment()}:`;
        const factory =
          NotificationSlackProjectorConfig.createCheckpointStoreFactory();
        return factory(redis, logger, envPrefix);
      },
    },
    {
      provide: SLACK_CONFIG_DI_TOKENS.CACHE_SERVICE, // 'SlackConfigCacheService'
      useExisting: CACHE_SERVICE, // 'CACHE_SERVICE'
    },
    {
      provide: SLACK_CONFIG_DI_TOKENS.CATCHUP_RUNNER, // 'SlackConfigCatchupRunner'
      inject: [
        EventStoreService,
        SLACK_CONFIG_DI_TOKENS.CHECKPOINT_STORE,
        APP_LOGGER,
      ],
      useFactory: (
        eventStoreService: EventStoreService,
        checkpointStore: CheckpointStore,
        logger: Logger,
      ) => {
        return new CatchUpRunner(eventStoreService, checkpointStore, logger);
      },
    },
    TemplateProjector,
  ],
  controllers: [TemplateProjectorHealthController],
  exports: [TemplateProjector],
})
export class TemplateProjectorModule {}
