// @generated by gen v1.0.0 hash:regen
// REMOVE THIS COMMENT TO STOP AUTOMATIC UPDATES TO THIS BLOCK

import { Logger } from 'src/shared/logging';
import { ActorContext } from 'src/shared/application/context';
import { EventEncryptionFactory } from 'src/shared/infrastructure/encryption';
import { SecretRefDecryptionUtil } from 'src/shared/infrastructure/encryption/utilities/secret-ref-decryption.util';
import { WebhookEncryptionConfig } from '../encryption/webhook-encryption.config';

/**
 * Webhook Decryption Utility
 *
 * Domain-specific wrapper around the shared SecretRefDecryptionUtil.
 * Provides Webhook-specific convenience methods while leveraging
 * the shared decryption infrastructure.
 *
 * This utility:
 * 1. Uses shared SecretRefDecryptionUtil for common decryption pipeline
 * 2. Applies Webhook-specific encryption configuration
 * 3. Provides typed convenience methods for common Webhook fields
 * 4. Maintains domain-specific context and error handling
 *
 * Used by both WebhookQueryRepository and WebhookReaderRepository
 * to eliminate code duplication and ensure consistent decryption behavior.
 *
 * @domain Notification Context - Webhook Decryption Utility
 * @layer Infrastructure
 * @pattern Domain-Specific Wrapper + Shared Infrastructure
 */
export class WebhookDecryptionUtil {
  /**
   * Parse and decrypt SecretRef fields using shared SecretRefDecryptionUtil
   *
   * Webhook-specific wrapper around the shared SecretRefDecryptionUtil.
   * Uses Webhook encryption configuration and event types while leveraging
   * the common decryption pipeline.
   *
   * @param secretFields - Record of field names to encrypted values (JSON strings or plain strings)
   * @param actor - Actor context for decryption
   * @param eventEncryptionFactory - Factory for handling encryption/decryption operations
   * @param logger - Logger instance for error reporting
   * @returns Promise resolving to record of field names to decrypted string values
   */
  static async decryptSecretRefFields(
    secretFields: Record<string, string | undefined>,
    actor: ActorContext,
    eventEncryptionFactory: EventEncryptionFactory,
    logger: Logger,
  ): Promise<Record<string, string | undefined>> {
    const secretConfig = WebhookEncryptionConfig.createSecretRefConfig();

    return SecretRefDecryptionUtil.decryptSecretRefFields(
      secretFields,
      actor,
      eventEncryptionFactory,
      secretConfig,
      'WebhookQuery',
      logger,
      {
        method: 'WebhookDecryptionUtil.decryptSecretRefFields',
        domain: 'Webhook',
      },
    );
  }

  /**
   * Decrypt specific Webhook fields commonly used across repositories
   *
   * Convenience wrapper for the most common Webhook field decryption pattern.
   * Handles the standard fields: signingSecret, authToken, apiKey.
   *
   * @param webhookData - Object containing encrypted Webhook fields
   * @param actor - Actor context for decryption
   * @param eventEncryptionFactory - Factory for handling encryption/decryption operations
   * @param logger - Logger instance for error reporting
   * @returns Promise resolving to decrypted field values
   */
  static async decryptWebhookFields(
    webhookData: {
      signingSecret?: string;
      authToken?: string;
      apiKey?: string;
    },
    actor: ActorContext,
    eventEncryptionFactory: EventEncryptionFactory,
    logger: Logger,
  ): Promise<{
    signingSecret?: string;
    authToken?: string;
    apiKey?: string;
  }> {
    const decryptedFields = await this.decryptSecretRefFields(
      {
        signingSecret: webhookData.signingSecret,
        authToken: webhookData.authToken,
        apiKey: webhookData.apiKey,
      },
      actor,
      eventEncryptionFactory,
      logger,
    );

    return {
      signingSecret: decryptedFields.signingSecret,
      authToken: decryptedFields.authToken,
      apiKey: decryptedFields.apiKey,
    };
  }
}
