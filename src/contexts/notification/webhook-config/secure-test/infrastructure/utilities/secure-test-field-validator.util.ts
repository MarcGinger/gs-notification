// @generated by gen v1.0.0 hash:regen
// REMOVE THIS COMMENT TO STOP AUTOMATIC UPDATES TO THIS BLOCK
import {
  DetailSecureTestResponse,
  SecureTestSignatureAlgorithmValue,
  SecureTestTypeValue,
} from '../../application/dtos';

/**
 * SecureTest Field Validator Utility
 *
 * Centralized utility for parsing and validating SecureTest aggregate data from EventStore events.
 * Provides consistent field validation patterns that can be reused across repositories
 * and projectors for SecureTest domain operations.
 *
 * @domain Notification Context - SecureTest Field Validation Utility
 * @layer Infrastructure
 * @pattern Utility Pattern + Field Validation
 */
export class SecureTestFieldValidatorUtil {
  /**
   * Create a validated DetailSecureTestResponse from raw EventStore event data
   *
   * Uses modern safeParseJSON utilities and DTOs to maintain CQRS compliance.
   * This creates read model data for projections, not domain props.
   *
   * @param aggregateData - Raw event data from EventStore
   * @returns Validated DetailSecureTestResponse DTO with all required fields
   * @throws Error if required fields are missing or invalid
   */
  static createSecureTestSnapshotFromEventData(
    aggregateData: Record<string, any>,
  ): DetailSecureTestResponse & {
    version: number;
    createdAt: Date;
    updatedAt: Date;
  } {
    // Extract simple fields directly from event data
    const id = aggregateData.id as string;
    const name = aggregateData.name as string;
    const description = aggregateData.description as string;
    const type = aggregateData.type as SecureTestTypeValue;
    const signatureAlgorithm =
      aggregateData.signatureAlgorithm as SecureTestSignatureAlgorithmValue;

    // Extract version and timestamps with proper type conversion
    const version =
      typeof aggregateData.version === 'string'
        ? parseInt(aggregateData.version, 10)
        : (aggregateData.version as number);
    const createdAt =
      typeof aggregateData.createdAt === 'string'
        ? new Date(aggregateData.createdAt)
        : (aggregateData.createdAt as Date);
    const updatedAt =
      typeof aggregateData.updatedAt === 'string'
        ? new Date(aggregateData.updatedAt)
        : (aggregateData.updatedAt as Date);

    // Return SecretRef objects as JSON strings for Redis storage
    // This maintains backward compatibility with snapshot props structure
    // but stores encrypted SecretRef objects instead of plain text
    return {
      id,
      name,
      description,
      type,
      // For backward compatibility, still return the expected interface
      // but now with SecretRef support we'll add a new method for projector
      signingSecret: undefined,
      signatureAlgorithm,
      username: undefined,
      password: undefined,
      version,
      createdAt,
      updatedAt,
    };
  }

  /**
   * Create projector data with SecretRef objects for Redis storage
   *
   * This method extracts SecretRef objects from event data and serializes them
   * as JSON strings for storage in Redis. The reader repository will deserialize
   * and resolve these SecretRef objects back to actual secret values.
   *
   * @param aggregateData - Raw event data from EventStore containing SecretRef objects
   * @returns Projector data object with SecretRef fields as JSON strings
   */
  static createSecureTestProjectorDataFromEventData(
    aggregateData: Record<string, any>,
  ): {
    id: string;
    name: string;
    description?: string;
    type: SecureTestTypeValue;
    signingSecretRef?: string;
    signatureAlgorithm?: SecureTestSignatureAlgorithmValue;
    usernameRef?: string;
    passwordRef?: string;
    version: number;
    createdAt: Date;
    updatedAt: Date;
  } {
    // Extract simple fields directly from event data
    const id = aggregateData.id as string;
    const name = aggregateData.name as string;
    const description = aggregateData.description as string;
    const type = aggregateData.type as SecureTestTypeValue;
    const signatureAlgorithm =
      aggregateData.signatureAlgorithm as SecureTestSignatureAlgorithmValue;

    // Extract SecretRef objects from domain state and serialize to JSON for Redis storage
    // The domain event contains SecretRef objects, not plain text values
    const signingSecretRef = aggregateData.signingSecretRef
      ? JSON.stringify(aggregateData.signingSecretRef)
      : undefined;
    const usernameRef = aggregateData.usernameRef
      ? JSON.stringify(aggregateData.usernameRef)
      : undefined;
    const passwordRef = aggregateData.passwordRef
      ? JSON.stringify(aggregateData.passwordRef)
      : undefined;

    // Extract version and timestamps with proper type conversion
    const version =
      typeof aggregateData.version === 'string'
        ? parseInt(aggregateData.version, 10)
        : (aggregateData.version as number);
    const createdAt =
      typeof aggregateData.createdAt === 'string'
        ? new Date(aggregateData.createdAt)
        : (aggregateData.createdAt as Date);
    const updatedAt =
      typeof aggregateData.updatedAt === 'string'
        ? new Date(aggregateData.updatedAt)
        : (aggregateData.updatedAt as Date);

    return {
      id,
      name,
      description,
      type,
      signingSecretRef,
      signatureAlgorithm,
      usernameRef,
      passwordRef,
      version,
      createdAt,
      updatedAt,
    };
  }
}
